<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>ç¬¬äº”äººæ ¼æ’ä½è®¡ç®—å™¨ï¼ˆå®Œæ•´ç‰ˆ - ä¼˜åŒ–ç‰ˆï¼‰</title>
    <style>
        :root {
            --primary-color: #0066ff;
            --primary-hover: #0052cc;
            --background-color: #f4f6f9;
            --surface-color: #ffffff;
            --text-color: #2c3e50;
            --border-color: #e0e6ed;
            --success-bg: #e6f7f0;
            --success-border: #00b069;
            --section-header-bg: #f8faff;
        }
        @keyframes fadeInSlideUp {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        body {
            font-family: 'Helvetica Neue', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft YaHei', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 20px;
            min-height: 100vh;
            margin: 0;
        }
        .container {
            width: 100%;
            max-width: 920px;
            background-color: var(--surface-color);
            padding: 20px 28px 30px 28px;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.08);
        }
        h1 {
            text-align: center;
            color: #1a2c50;
            margin-bottom: 18px;
        }
        .section {
            border: 1px solid var(--border-color);
            border-radius: 12px;
            margin-bottom: 18px;
            overflow: hidden;
            transition: box-shadow 0.3s;
        }
        .section-header {
            background-color: var(--section-header-bg);
            padding: 12px 18px;
            font-size: 1.05em;
            font-weight: 600;
            border-bottom: 1px solid var(--border-color);
        }
        .section-content { padding: 18px; }
        .form-group { margin-bottom: 16px; }
        .form-group label {
            display: flex; align-items: center; margin-bottom: 8px;
            font-weight: 500; color: #555;
        }
        input[type="number"], select {
            width: 100%; padding: 10px; border: 1px solid var(--border-color);
            border-radius: 8px; box-sizing: border-box; transition: all 0.25s;
        }
        input[type="range"] { width: 100%; }
        input[type="number"]:focus, select:focus {
            outline: none; border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 102, 255, 0.12);
        }
        .rank-selector { display: grid; grid-template-columns: 2fr 2fr 1.5fr; gap: 10px; }
        .button-group { display: flex; gap: 12px; margin-top: 8px; }
        button {
            flex: 1; padding: 12px; color: white; border: none; border-radius: 8px;
            font-size: 16px; font-weight: bold; cursor: pointer; transition: all 0.25s;
        }
        #calculateBtn { background: linear-gradient(45deg, var(--primary-color), var(--primary-hover)); }
        #calculateBtn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0, 102, 255, 0.18); }
        #resetFormBtn { background-color: #6c757d; }
        #resetFormBtn:hover { background-color: #5a6268; transform: translateY(-2px); }
        #result {
            margin-top: 18px; padding: 18px; background-color: var(--success-bg);
            border-left: 5px solid var(--success-border); border-radius: 8px;
            display: none; animation: fadeInSlideUp 0.45s ease-out forwards;
        }
        #result p { margin: 8px 0; font-size: 1.03em;}
        .error { color: #d93025; font-weight: 500; text-align: center; margin-top: 12px; padding: 10px; border-radius: 8px; background: #fbeae9; display: none; }
        .tooltip {
            position: relative; display: inline-flex; justify-content: center; align-items: center;
            width: 18px; height: 18px; margin-left: 8px; background-color: #a0aec0; color: white; border-radius: 50%;
            font-family: serif; font-style: italic; font-weight: bold; font-size: 14px; cursor: pointer; user-select: none;
        }
        .tooltip .tooltiptext {
            visibility: hidden; width: 280px; background-color: #343a40; color: #fff;
            text-align: left; border-radius: 6px; padding: 10px; position: absolute;
            z-index: 1; bottom: 125%; left: 50%; margin-left: -140px; opacity: 0;
            transition: opacity 0.25s; font-size: 0.86em;
        }
        .tooltip:hover { background-color: var(--primary-color); }
        .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }
        .slider-group { display: flex; align-items: center; gap: 12px; }
        .slider-group input[type="range"] { flex: 1; }
        .slider-group span { font-weight: 500; min-width: 48px; text-align: right; }
        .footer { text-align: center; margin-top: 28px; padding-top: 14px; border-top: 1px solid var(--border-color); }
        .author-credit { font-weight: 600; color: var(--text-color); margin-bottom: 8px; font-size: 0.9em; }
        .disclaimer { font-size: 0.82em; color: #6c757d; margin: 0; }
        @media (max-width: 760px) {
            .container { padding: 14px; }
            .rank-selector { grid-template-columns: 1fr; }
            .button-group { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ç¬¬äº”äººæ ¼æ’ä½è®¡ç®—å™¨ï¼ˆå®Œæ•´ç‰ˆ - ä¼˜åŒ–ï¼‰</h1>
        
        <form id="calculator-form">
            <div class="section">
                <div class="section-header">â‘  æ ¸å¿ƒå‚æ•°</div>
                <div class="section-content">
                    <div class="form-group">
                        <label for="startTier">åˆå§‹æ®µä½</label>
                        <div class="rank-selector">
                            <select id="startTier"></select>
                            <select id="startSubTier"></select>
                            <select id="startStars"></select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="targetTier">ç›®æ ‡æ®µä½</label>
                        <div class="rank-selector" style="grid-template-columns: 1fr 1fr;">
                            <select id="targetTier"></select>
                            <select id="targetSubTier"></select>
                        </div>
                        <div id="peak-star-target-wrapper" class="form-group" style="display:none; margin-top: 10px;">
                            <label for="peakTargetStars">è¾“å…¥ç›®æ ‡æ˜Ÿæ•°ï¼ˆå·…å³°ä¸ƒé˜¶ï¼‰</label>
                            <input type="number" id="peakTargetStars" value="26" min="26">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="gameWinRate">æ¸¸æˆå†…æ’ä½èƒœç‡ (%) 
                            <div class="tooltip">i<span class="tooltiptext">è¯·å¡«å…¥ä¸ªäººæ¡£æ¡ˆä¸­çš„â€œæ’ä½èƒœç‡â€ï¼šèƒœå±€ / (æ€»å±€æ•° - å¹³å±€æ•°)ã€‚</span></div>
                        </label>
                        <input type="number" id="gameWinRate" placeholder="ä¾‹å¦‚: 50" min="0" max="100">
                    </div>
                    <div class="form-group">
                        <label for="totalDrawRate">å¹³å±€åœ¨æ€»å¯¹å±€ä¸­çš„é¢„ä¼°å æ¯” (%) 
                            <div class="tooltip">i<span class="tooltiptext">ä¾‹ï¼š10å±€é‡Œ2å±€å¹³å±€åˆ™å¡« 20ã€‚ç”¨äºåæ¨çœŸå®çš„èƒœ/è´Ÿæ¦‚ç‡ã€‚</span></div>
                        </label>
                        <input type="number" id="totalDrawRate" placeholder="ä¾‹å¦‚: 15" min="0" max="100">
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-header">â‘¡ æ¸¸æˆä¹ æƒ¯ä¸é¢å¤–åŠ åˆ†é¡¹</div>
                <div class="section-content">
                     <div class="form-group">
                        <label>é€‰æ‹©é˜µè¥</label>
                        <select id="faction-select">
                            <option value="survivor">æ±‚ç”Ÿè€…</option>
                            <option value="hunter">ç›‘ç®¡è€…</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="queueTime">å¹³å‡æ’é˜Ÿ+BPæ—¶é—´ (åˆ†é’Ÿ)</label>
                        <input type="number" id="queueTime" placeholder="ä¾‹å¦‚: 3" min="0">
                    </div>
                    <div class="form-group">
                        <label for="matchTime">å¹³å‡å¯¹å±€æ—¶é—´ (åˆ†é’Ÿ)</label>
                        <input type="number" id="matchTime" placeholder="ä¾‹å¦‚: 10" min="0">
                    </div>
                    <div class="form-group">
                        <label for="playHours">æ¯æ—¥æ’ä½æ—¶é•¿ (å°æ—¶)</label>
                        <input type="number" id="playHours" placeholder="ä¾‹å¦‚: 2" min="0">
                    </div>
                    
                    <div id="survivor-options">
                        <div class="form-group">
                            <label><input type="checkbox" id="isSolo"> æˆ‘æ˜¯å•äººæ’ä½</label>
                        </div>
                        <div class="form-group">
                            <label>â€œè™½è´¥çŠ¹è£â€åŠ åˆ†é¢‘ç‡
                                 <div class="tooltip">i<span class="tooltiptext">åœ¨è´¥/å¹³å±€ä¸­ï¼Œæ‚¨æœ‰å‡ ç‡è·å¾—è¡¨ç°ç±»é¢å¤–åŠ åˆ†ï¼ˆä¾‹å¦‚ç‰µåˆ¶ã€æ•‘æ´ç­‰ï¼‰ï¼Ÿ</span></div>
                            </label>
                             <div class="slider-group">
                                <input type="range" id="diligenceFreq" min="0" max="100" value="20" step="1">
                                <span id="diligenceFreqValue">20%</span>
                            </div>
                        </div>
                         <div class="form-group">
                            <label>é˜Ÿå‹æŒ‚æœºé¢‘ç‡
                                 <div class="tooltip">i<span class="tooltiptext">é¢„ä¼°æ‚¨é‡åˆ°é˜Ÿå‹æŒ‚æœºå¹¶å› æ­¤è·å¾—è¡¥å¿åˆ†çš„å¯¹å±€å æ¯”ï¼ˆé»˜è®¤æä½ï¼‰ã€‚</span></div>
                            </label>
                             <div class="slider-group">
                                <input type="range" id="afkFreq" min="0" max="100" value="0.5" step="0.5">
                                <span id="afkFreqValue">0.5%</span>
                            </div>
                        </div>
                    </div>
                    <div id="hunter-options" style="display: none;">
                        <div class="form-group">
                            <label>å¹³/è´Ÿå±€è·å¾—â€œæœ€ä½³æ¼”ç»â€åŠ åˆ†é¢‘ç‡</label>
                             <div class="slider-group">
                                <input type="range" id="bestPerfFreq" min="0" max="100" value="30" step="1">
                                <span id="bestPerfFreqValue">30%</span>
                            </div>
                        </div>
                         <div class="form-group">
                            <label>é‡åˆ°å¤šæ’é˜Ÿä¼åŠ åˆ†é¢‘ç‡ (é»˜å¥‘çš„å¯¹æ‰‹)
                                <div class="tooltip">i<span class="tooltiptext">é¢„ä¼°æ‚¨é‡åˆ°å¤šæ’é˜Ÿä¼å¹¶è·å¾—é¢å¤–åˆ†çš„å‡ ç‡ï¼ˆé«˜æ®µä½æ›´å¸¸è§ï¼‰ã€‚</span></div>
                            </label>
                            <div class="slider-group">
                                <input type="range" id="teamEncounterFreq" min="0" max="100" value="40" step="1">
                                <span id="teamEncounterFreqValue">40%</span>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>é‡åˆ°å¼ºæ•ŒåŠ åˆ†é¢‘ç‡ (åŠ›æŠ—å¼ºæ•Œ/åŠ›æˆ˜å¤©é€‰)
                             <div class="tooltip">i<span class="tooltiptext">é¢„ä¼°æ‚¨é‡åˆ°æ®µä½æ˜æ˜¾é«˜äºè‡ªèº«å¹¶è·å¾—è¡¥å¿åˆ†çš„å¯¹å±€å æ¯”ã€‚</span></div>
                        </label>
                         <div class="slider-group">
                            <input type="range" id="strongEnemyFreq" min="0" max="100" value="40" step="1">
                            <span id="strongEnemyFreqValue">40%</span>
                        </div>
                    </div>
                </div>
            </div>
        </form>
        
        <div class="button-group">
            <button id="calculateBtn" type="button">ğŸš€ å¼€å§‹è®¡ç®—</button>
            <button id="resetFormBtn" type="button">ğŸ”„ ä¸€é”®é‡ç½®</button>
        </div>
        <div id="error-message" class="error"></div>
        <div id="result"></div>
        
        <div class="section" style="margin-top: 20px;">
             <div class="section-header">â‘¢ èµ›å­£æ®µä½é‡ç½®å·¥å…·</div>
             <div class="section-content">
                 <div class="form-group">
                     <label for="seasonEndTier">é€‰æ‹©æ‚¨çš„èµ›å­£æœ«æ®µä½</label>
                     <div class="rank-selector" style="grid-template-columns: 1fr 1fr;">
                         <select id="seasonEndTier"></select>
                         <select id="seasonEndSubTier"></select>
                     </div>
                 </div>
                 <div class="form-group" style="display: flex; justify-content: center;">
                    <button id="resetBtn" type="button">æŸ¥çœ‹æ–°èµ›å­£æ®µä½</button>
                 </div>
                 <div id="resetResult" style="text-align: center; margin-top: 12px; font-weight: bold; font-size: 1.02em;"></div>
             </div>
         </div>
         
         <div class="footer">
            <p class="author-credit">ä½œè€…Bç«™ï¼šé¢æˆ‘æ˜¯WZäºº</p>
            <p class="disclaimer">å…è´£å£°æ˜ï¼šæœ¬è®¡ç®—ä¸ºåŸºäºè§„åˆ™ä¸å¹³å‡æœŸæœ›çš„ç†è®ºä¼°ç®—ï¼Œç»“æœå—å‚æ•°å‡†ç¡®æ€§å½±å“ï¼Œä»…ä¾›å‚è€ƒã€‚</p>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        /**********************
         * æ®µä½æ•°æ®ï¼ˆç»´æŒä½ åŸå§‹è®¾å®šï¼‰
         **********************/
        const rankData = [
            {id:1,name:"ä¸€é˜¶",subTiers:3,starsPerSub:3,pointsPerStar:20},
            {id:2,name:"äºŒé˜¶",subTiers:4,starsPerSub:4,pointsPerStar:20},
            {id:3,name:"ä¸‰é˜¶",subTiers:5,starsPerSub:5,pointsPerStar:20},
            {id:4,name:"å››é˜¶",subTiers:5,starsPerSub:5,pointsPerStar:20},
            {id:5,name:"äº”é˜¶",subTiers:5,starsPerSub:5,pointsPerStar:30},
            {id:6,name:"å…­é˜¶",subTiers:5,starsPerSub:5,pointsPerStar:30},
            {id:7,name:"ä¸ƒé˜¶",subTiers:1,starsPerSub:25,pointsPerStar:30},
            {id:8,name:"å·…å³°ä¸ƒé˜¶",subTiers:1,starsPerSub:Infinity,pointsPerStar:30}
        ];
        const subTierNames = ["I","II","III","IV","V"];

        // è®¡ç®—æ¯ä¸ªæ®µä½èµ·å§‹ç§¯åˆ†ä»¥åŠæ¯ä¸ªå­æ®µé¡¶ç‚¹ç§¯åˆ†ï¼ˆå’Œä½ åŸå§‹è„šæœ¬ä¿æŒä¸€è‡´ï¼‰
        let pointsToStartTier = {};
        let totalPointsMap = {};
        let cumulative = 0;
        for (let i = 0; i < rankData.length; i++) {
            const tier = rankData[i];
            pointsToStartTier[tier.id] = cumulative;
            if (tier.id !== 8) {
                const totalStarsInTier = (tier.id === 7) ? 25 : tier.subTiers * tier.starsPerSub;
                cumulative += totalStarsInTier * tier.pointsPerStar;
            }
            // è®¡ç®—æ¯ä¸ªå­æ®µçš„â€œåˆ°è¾¾è¯¥å­æ®µæœ€é«˜ä½ç½®æ‰€éœ€ç§¯åˆ†â€ï¼ˆä»…ç”¨äºç›®æ ‡é€‰æ‹©æ˜ å°„ï¼‰
            if (tier.id < 7) {
                for (let s = 1; s <= tier.subTiers; s++) {
                    // ä½¿ç”¨ä¸ä½ åŸè„šæœ¬ç›¸åŒçš„æ˜ å°„æ–¹æ³•ï¼Œä¿è¯è¡Œä¸ºä¸€è‡´
                    totalPointsMap[`${tier.id}-${s}`] = pointsToStartTier[tier.id] + (tier.subTiers - s + 1) * tier.starsPerSub * tier.pointsPerStar;
                }
            }
        }
        // ä¸ƒé˜¶ä¸å·…å³°æ˜ å°„
        totalPointsMap['7-1'] = pointsToStartTier[8];
        totalPointsMap['8-1'] = pointsToStartTier[8];

        /**********************
         * DOM å¼•ç”¨
         **********************/
        const allDOM = {
            startTier: document.getElementById("startTier"),
            startSubTier: document.getElementById("startSubTier"),
            startStars: document.getElementById("startStars"),
            targetTier: document.getElementById("targetTier"),
            targetSubTier: document.getElementById("targetSubTier"),
            peakTargetStars: document.getElementById("peakTargetStars"),
            seasonEndTier: document.getElementById("seasonEndTier"),
            seasonEndSubTier: document.getElementById("seasonEndSubTier"),
            calculateBtn: document.getElementById("calculateBtn"),
            resetBtn: document.getElementById("resetBtn"),
            resetFormBtn: document.getElementById("resetFormBtn"),
            resultDiv: document.getElementById("result"),
            resetResultDiv: document.getElementById("resetResult"),
            errorMessageDiv: document.getElementById("error-message"),
            factionSelect: document.getElementById("faction-select"),
            survivorOptions: document.getElementById("survivor-options"),
            hunterOptions: document.getElementById("hunter-options"),
            diligenceSlider: document.getElementById("diligenceFreq"),
            diligenceValue: document.getElementById("diligenceFreqValue"),
            afkSlider: document.getElementById("afkFreq"),
            afkValue: document.getElementById("afkFreqValue"),
            bestPerfSlider: document.getElementById("bestPerfFreq"),
            bestPerfValue: document.getElementById("bestPerfFreqValue"),
            teamEncounterSlider: document.getElementById("teamEncounterFreq"),
            teamEncounterValue: document.getElementById("teamEncounterFreqValue"),
            strongEnemySlider: document.getElementById("strongEnemyFreq"),
            strongEnemyValue: document.getElementById("strongEnemyFreqValue"),
            isSoloCheckbox: document.getElementById("isSolo"),
        };

        /**********************
         * Helperï¼šå¡«å……ä¸‹æ‹‰é¡¹ä¸æ˜Ÿæ•°è¾“å…¥ï¼ˆæ²¿ç”¨å¹¶ä¿®æ­£ä½ åŸå§‹é€»è¾‘ï¼‰
         **********************/
        function populateTierSelect(selectElement) {
            selectElement.innerHTML = "";
            for (let i = 1; i <= 8; i++) {
                const option = document.createElement("option");
                option.value = i;
                option.textContent = rankData[i-1].name;
                selectElement.appendChild(option);
            }
        }
        function updateSubTierSelect(tierSelect, subTierSelect, selectorType) {
            const tierId = parseInt(tierSelect.value);
            const tier = rankData.find(t => t.id === tierId);
            subTierSelect.innerHTML = '';
            if (tierId === 7 && selectorType === 'target') {
                // 0..24 ä»£è¡¨ä¸ƒé˜¶ 0..24 æ˜Ÿ
                for (let i = 0; i <= 24; i++) {
                    const option = document.createElement("option");
                    option.value = i;
                    option.textContent = `${i} æ˜Ÿ`;
                    subTierSelect.appendChild(option);
                }
            } else if (tierId >= 7) {
                const option = document.createElement("option");
                option.value = 1;
                option.textContent = (selectorType === 'target') ? "è¾¾åˆ°è¯¥æ®µä½" : (tierId === 8 ? "25æ˜Ÿä»¥ä¸Š" : "0-24æ˜Ÿ");
                subTierSelect.appendChild(option);
            } else {
                // å¡«å……å°æ®µï¼ˆæ³¨æ„ï¼šå’ŒåŸæ¥ä¿æŒä¸€è‡´ï¼Œvalue ä½¿ç”¨ iï¼‰
                for (let i = tier.subTiers; i >= 1; i--) {
                    const option = document.createElement("option");
                    option.value = i;
                    option.textContent = `${subTierNames[i-1]}æ®µ`;
                    subTierSelect.appendChild(option);
                }
            }
        }
        function updateStartStarsSelect() {
            const tierId = parseInt(allDOM.startTier.value);
            const tier = rankData.find(t => t.id === tierId);
            let starsEl = document.getElementById("startStars") || document.getElementById("peakStarsInput");
            // if tier is peak seven, show numeric input starting at 25
            if (tier.name === "å·…å³°ä¸ƒé˜¶") {
                // create numeric input if not exists
                if (!starsEl || starsEl.tagName === "SELECT") {
                    const input = document.createElement("input");
                    input.type = "number";
                    input.min = 25;
                    input.value = 25;
                    input.id = "startStars";
                    input.style.padding = "10px";
                    starsEl.replaceWith(input);
                }
            } else {
                // ensure select exists
                if (!starsEl || starsEl.tagName === "INPUT") {
                    const select = document.createElement("select");
                    select.id = "startStars";
                    starsEl.replaceWith(select);
                    starsEl = select;
                }
                starsEl.innerHTML = "";
                const starsNeeded = (tier.id === 7) ? 25 : tier.starsPerSub;
                for (let i = 0; i < starsNeeded; i++) {
                    const option = document.createElement("option");
                    option.value = i;
                    option.textContent = `${i} æ˜Ÿ`;
                    starsEl.appendChild(option);
                }
            }
        }

        /**********************
         * å¡«å……åˆå§‹ UI å¹¶è®¾ç½®ç›‘å¬
         **********************/
        populateTierSelect(allDOM.startTier);
        populateTierSelect(allDOM.targetTier);
        populateTierSelect(allDOM.seasonEndTier);
        updateSubTierSelect(allDOM.startTier, allDOM.startSubTier, 'start');
        updateSubTierSelect(allDOM.targetTier, allDOM.targetSubTier, 'target');
        updateSubTierSelect(allDOM.seasonEndTier, allDOM.seasonEndSubTier, 'seasonEnd');
        updateStartStarsSelect();

        allDOM.startTier.addEventListener("change", () => { updateSubTierSelect(allDOM.startTier, allDOM.startSubTier, 'start'); updateStartStarsSelect(); });
        allDOM.startSubTier.addEventListener("change", updateStartStarsSelect);
        allDOM.targetTier.addEventListener("change", () => { updateSubTierSelect(allDOM.targetTier, allDOM.targetSubTier, 'target'); togglePeakTargetInput(); });
        allDOM.seasonEndTier.addEventListener("change", () => updateSubTierSelect(allDOM.seasonEndTier, allDOM.seasonEndSubTier, 'seasonEnd'));

        function togglePeakTargetInput() {
            allDOM.targetTier.value === "8" ? document.getElementById("peak-star-target-wrapper").style.display = "block" : document.getElementById("peak-star-target-wrapper").style.display = "none";
        }
        togglePeakTargetInput();

        // slider æ˜¾ç¤ºå€¼ç»‘å®š
        const sliderPairs = [
            {el: allDOM.diligenceSlider, valEl: allDOM.diligenceValue},
            {el: allDOM.afkSlider, valEl: allDOM.afkValue},
            {el: allDOM.bestPerfSlider, valEl: allDOM.bestPerfValue},
            {el: allDOM.teamEncounterSlider, valEl: allDOM.teamEncounterValue},
            {el: allDOM.strongEnemySlider, valEl: allDOM.strongEnemyValue},
        ];
        sliderPairs.forEach(p => {
            if (!p.el) return;
            p.valEl.textContent = `${p.el.value}%`;
            p.el.addEventListener("input", () => { p.valEl.textContent = `${p.el.value}%`; });
        });

        // é˜µè¥åˆ‡æ¢
        allDOM.factionSelect.addEventListener("change", e => {
            const isSurvivor = e.target.value === "survivor";
            allDOM.survivorOptions.style.display = isSurvivor ? "block" : "none";
            allDOM.hunterOptions.style.display = isSurvivor ? "none" : "block";
            // å¾®è°ƒå¼ºæ•Œé»˜è®¤å€¼
            if (isSurvivor) {
                allDOM.strongEnemySlider.value = 40; allDOM.strongEnemyValue.textContent = "40%";
            } else {
                allDOM.strongEnemySlider.value = 10; allDOM.strongEnemyValue.textContent = "10%";
            }
        });

        /**********************
         * ç§¯åˆ†æ˜ å°„å‡½æ•°ï¼ˆå¤ç”¨å¹¶ç•¥å¾®æ•´ç†ï¼‰
         **********************/
        function getPointsForRank(tierId, subTierId, stars) {
            const tier = rankData.find(t => t.id === tierId);
            if (!tier) return 0;
            // å·…å³°ä¸ƒé˜¶ï¼šä» 25 æ˜Ÿå¼€å§‹ç´¯åŠ 
            if (tier.name === "å·…å³°ä¸ƒé˜¶") {
                // stars åº”ä¸ºå®é™…æ˜Ÿæ•°ï¼ˆä¾‹å¦‚ 26 -> 1 æ˜Ÿçš„é¢å¤–ï¼‰
                const base = pointsToStartTier[8];
                return base + Math.max(0, (stars - 25)) * tier.pointsPerStar;
            }
            let basePoints = pointsToStartTier[tierId];
            if (tierId < 7) {
                // æ³¨æ„ï¼šsubTierId çš„å€¼ä¸UIä¸€è‡´ï¼ˆ1..subTiersï¼‰
                basePoints += (tier.subTiers - subTierId) * tier.starsPerSub * tier.pointsPerStar;
            }
            return basePoints + stars * tier.pointsPerStar;
        }
        function getRankFromPoints(points) {
            if (points >= pointsToStartTier[8]) return {tier:8};
            for (let i = 7; i >= 1; i--) {
                if (points >= pointsToStartTier[i]) return {tier:i};
            }
            return {tier:1};
        }

        /**********************
         * ä¸»è®¡ç®—é€»è¾‘ï¼šåŸºäºæœŸæœ›å€¼å¯¹å±€å¾—åˆ†ï¼ˆå«æ›´ç»†åˆ†çš„ç»“å±€åˆ†å¸ƒï¼‰
         **********************/
        function calculateExpectedBreakdownPerMatch(inputs, currentRank) {
            // inputs ä¸­ pWin, pDraw, pLoss, åˆ†æ´¾å¥½çš„å„ç±»ç»“å±€ pFourEscape etc.
            // è¿”å›å¯¹è±¡ï¼š{win, draw, loss, performance, protection, bonus, avg}
            const breakdown = {win:0, draw:0, loss:0, performance:0, protection:0, bonus:0};
            if (inputs.faction === "survivor") {
                // åŸºç¡€èƒœè´Ÿåˆ†ï¼ˆæŒ‰å¤šä¸ªç»“å±€ï¼‰
                breakdown.win += (inputs.pFourEscape * 10 + inputs.pThreeEscape * 9);
                breakdown.draw += inputs.pDraw * 1;
                breakdown.loss += (inputs.pSingleEscape * -6 + inputs.pAllDead * -8);

                // ä¸‰é˜¶/å››é˜¶/äº”é˜¶ï¼šèƒœåˆ©æˆ–å¹³å±€æ—¶é¢å¤– +1
                if ([3,4,5].includes(currentRank.tier)) {
                    breakdown.win += inputs.pWin * 1;
                    breakdown.draw += inputs.pDraw * 1;
                }

                // æ¼”ç»åˆ†ï¼ŒæœŸæœ› 1~4 -> 2.0ï¼ˆæ›´ä¿å®ˆï¼‰
                breakdown.performance = 2.0;

                // å•æ’åŠ æˆï¼ˆè‹¥å•äººæ’ä½ï¼‰
                if (inputs.isSolo) {
                    // å•æ’è¾¾æˆæ¡ä»¶æ—¶ä¼šæœ‰é¢å¤– 0~2 çš„è¡¥å¿ï¼ˆæˆ‘ä»¬æŒ‰æ¦‚ç‡æƒé‡ç»™æœŸæœ›ï¼‰
                    // ä»¥ pSoloAchievement ä¸ºè§¦å‘æ¦‚ç‡ï¼ˆç”± diligenceFreq ä¸ pLoss/pDraw å…±åŒå†³å®šï¼‰
                    const pSoloAchieve = Math.min(1, inputs.diligenceFreq * 0.6 + inputs.pWin * 0.05);
                    breakdown.bonus += pSoloAchieve * 1.0; // æœŸæœ›è´¡çŒ®
                }

                // è™½è´¥çŠ¹è£ / ç‰¹æ®Šæˆå°±ï¼ˆ+1~+2ï¼‰æŒ‰é¢‘ç‡å‚ä¸
                // ä¾æ® rank.txtï¼Œè‹¥è¾¾æˆç‰¹å®šæˆå°± +2ï¼›æˆ‘ä»¬ä»¥ diligenceFreq ä½œä¸ºè¯¥â€œè¾¾æˆâ€æ¦‚ç‡åœ¨å¤±è´¥/å¹³å±€æƒ…å½¢ä¸‹
                breakdown.bonus += (inputs.pLoss + inputs.pDraw) * inputs.diligenceFreq * 1.2;

                // é˜Ÿå‹æŒ‚æœºè¡¥å¿ï¼šè‹¥é˜Ÿå‹æŒ‚æœºï¼Œå…¶ä»–ç©å®¶ +2
                breakdown.bonus += inputs.afkFreq * 2;

            } else {
                // ç›‘ç®¡è€…
                breakdown.win += (inputs.pNoEscape * 9 + inputs.pOneEscape * 8);
                breakdown.draw += 0;
                breakdown.loss += (inputs.pLeaveOne * -6 + inputs.pAllEscape * -7);

                // æ¼”ç»åˆ†ï¼ˆæ·˜æ±°äººæ•°æ’åç»™ 1~4ï¼Œæˆ‘ä»¬å– 2.5ï¼‰
                breakdown.performance = 2.5;

                // æœ€ä½³æ¼”ç»ï¼šåœ¨å¹³/è´Ÿå±€æœ‰ä¸€å®šæ¦‚ç‡è·å¾— +1
                breakdown.bonus += (inputs.pDraw + inputs.pLoss) * inputs.bestPerfFreq * 1.0;

                // å¤šæ’é‡æ•Œï¼šç›‘ç®¡è€…ä¸Šåˆ†é¡¹ï¼ˆå››é˜¶ä»¥ä¸Šæ›´æ˜æ˜¾ï¼‰ï¼ŒæŒ‰é¢‘ç‡æœŸæœ› + (1~3)ï¼Œæˆ‘ä»¬ç”¨ 1.8 ä½œä¸ºç»éªŒå› å­
                breakdown.bonus += inputs.teamEncounterFreq * 1.8;
            }

            // å¼ºæ•Œè¡¥å¿ï¼ˆæ±‚/ç›‘éƒ½å¯è·å¾— +1 æˆ– +2ï¼‰ï¼Œæˆ‘ä»¬ç”¨ 1.2 ä½œä¸ºç»éªŒå› å­
            breakdown.bonus += inputs.strongEnemyFreq * 1.2;

            // æ®µä½ä¿æŠ¤ï¼ˆè§„åˆ™ï¼‰
            if (currentRank.tier === 2) breakdown.protection += inputs.pLoss * 5;
            if (currentRank.tier === 3) breakdown.protection += inputs.pLoss * 3;
            if (currentRank.tier === 4) breakdown.protection += inputs.pLoss * 2 + inputs.pDraw * 1;

            // è¿è´¥ç»ˆæ­¢æœŸæœ›è¡¥å¿ï¼ˆè§„åˆ™ï¼šç»ˆæ­¢è¿è´¥æ—¶è¡¥å¿æœ€å¤š +4ï¼‰
            // ç®€åŒ–ä¸ºä¸€ä¸ªæœŸæœ›å…¬å¼ï¼ˆè‹¥ä½ è¿è´¥å†èƒœåˆ©æ—¶ä¼šè§¦å‘ï¼‰
            const p = inputs.pLoss;
            const streakTerminationEV = inputs.pWin * (Math.pow(p,2)*1 + Math.pow(p,3)*2 + Math.pow(p,4)*3 + Math.pow(p,5)*4);
            breakdown.bonus += streakTerminationEV;

            // æ€»å’Œï¼ˆå– capï¼Œé¿å…å•å±€æœŸæœ›è¶…è¿‡ç°å®è¾¹ç•Œï¼‰
            let avg = breakdown.win + breakdown.draw + breakdown.loss + breakdown.performance + breakdown.protection + breakdown.bonus;

            // é™åˆ¶ï¼šé¢å¤–åŠ åˆ†ä¸åº”æ— é™å åŠ ï¼Œcap 4 åˆ†ï¼ˆç»éªŒå€¼ï¼‰
            const bonusCap = 4;
            const pureBonus = breakdown.bonus + breakdown.protection + breakdown.performance;
            // recompute avg using capped bonus part
            const cappedExtra = Math.min(bonusCap, pureBonus);
            avg = (breakdown.win + breakdown.draw + breakdown.loss) + cappedExtra;

            // è¿˜æ˜¯ä¿æŒæ¼”ç»+ä¿æŠ¤å•åˆ—æ˜¾ç¤ºï¼ˆä½†å¯¹ avg ä½¿ç”¨ cappedExtraï¼‰
            return {
                win: (breakdown.win + breakdown.draw + breakdown.loss) - (breakdown.loss), // baseline breakdown of win/draw/loss combined (for display)
                baseWinsAndDraws: breakdown.win + breakdown.draw + breakdown.loss,
                performance: breakdown.performance,
                protection: breakdown.protection,
                bonus: breakdown.bonus,
                cappedExtra: cappedExtra,
                avg: avg
            };
        }

        /**********************
         * è®¡ç®—æŒ‰é’®é€»è¾‘ï¼ˆå«æŒ‰æ®µä½è·³æ­¥ä»¥åŠ é€Ÿï¼‰
         **********************/
        allDOM.calculateBtn.addEventListener("click", () => {
            allDOM.errorMessageDiv.style.display = "none";
            allDOM.resultDiv.style.display = "none";

            // è¯»å–è¾“å…¥
            const startStarsEl = document.getElementById("startStars") || document.getElementById("peakStarsInput");
            const inputs = {
                faction: allDOM.factionSelect.value,
                startTier: parseInt(allDOM.startTier.value),
                startSubTier: parseInt(allDOM.startSubTier.value),
                startStars: parseInt(startStarsEl.value),
                targetTier: parseInt(allDOM.targetTier.value),
                targetSubTier: parseInt(allDOM.targetSubTier.value),
                gameWinRate: parseFloat(document.getElementById("gameWinRate").value),
                totalDrawRate: parseFloat(document.getElementById("totalDrawRate").value),
                queueTime: parseFloat(document.getElementById("queueTime").value),
                matchTime: parseFloat(document.getElementById("matchTime").value),
                playHours: parseFloat(document.getElementById("playHours").value),
                isSolo: document.getElementById("isSolo").checked,
                diligenceFreq: parseFloat(document.getElementById("diligenceFreq").value)/100,
                afkFreq: parseFloat(document.getElementById("afkFreq").value)/100,
                bestPerfFreq: parseFloat(document.getElementById("bestPerfFreq").value)/100,
                teamEncounterFreq: parseFloat(document.getElementById("teamEncounterFreq").value)/100,
                strongEnemyFreq: parseFloat(document.getElementById("strongEnemyFreq").value)/100,
                peakTargetStars: parseInt(document.getElementById("peakTargetStars").value)
            };

            // åŸºæœ¬æ ¡éªŒ
            const required = [inputs.gameWinRate, inputs.totalDrawRate, inputs.queueTime, inputs.matchTime, inputs.playHours];
            if (required.some(isNaN)) {
                showError("è¯·å¡«å†™æ‰€æœ‰æ ¸å¿ƒå‚æ•°ï¼ˆèƒœç‡/å¹³å±€ç‡/æ—¶é—´/æ¯æ—¥æ—¶é•¿ï¼‰ã€‚");
                return;
            }
            if (inputs.totalDrawRate >= 100 || inputs.gameWinRate > 100) {
                showError("èƒœç‡æˆ–å¹³å±€å æ¯”ä¸èƒ½è¶…è¿‡ 100%ã€‚");
                return;
            }
            if (inputs.playHours <= 0) {
                showError("æ¯æ—¥æ’ä½æ—¶é•¿å¿…é¡»å¤§äº 0ã€‚");
                return;
            }

            // å¤„ç†èµ·å§‹ä¸ç›®æ ‡ç§¯åˆ†
            const startPoints = getPointsForRank(inputs.startTier, inputs.startSubTier, inputs.startStars);
            let targetPoints = 0;
            if (inputs.targetTier === 8) {
                if (isNaN(inputs.peakTargetStars) || inputs.peakTargetStars <= 25) {
                    showError("å·…å³°ä¸ƒé˜¶ç›®æ ‡æ˜Ÿæ•°å¿…é¡»è‡³å°‘å¤§äº 25ã€‚");
                    return;
                }
                if (inputs.startTier === 8 && inputs.peakTargetStars <= inputs.startStars) {
                    showError("å·…å³°ä¸ƒé˜¶çš„ç›®æ ‡æ˜Ÿæ•°å¿…é¡»é«˜äºå½“å‰æ˜Ÿæ•°ã€‚");
                    return;
                }
                targetPoints = pointsToStartTier[8] + (inputs.peakTargetStars - 25) * rankData[7].pointsPerStar;
            } else if (inputs.targetTier === 7) {
                // targetSubTier ä»£è¡¨ 0..24 æ˜Ÿï¼ˆåœ¨ UI é‡Œï¼‰
                targetPoints = pointsToStartTier[7] + inputs.targetSubTier * rankData[6].pointsPerStar;
            } else {
                // ä½¿ç”¨ totalPointsMapï¼ˆä¸åŸé€»è¾‘ä¿æŒä¸€è‡´ï¼‰
                const key = `${inputs.targetTier}-${inputs.targetSubTier}`;
                if (totalPointsMap[key] !== undefined) {
                    targetPoints = totalPointsMap[key];
                } else {
                    // fallbackï¼šä½¿ç”¨è¯¥æ®µä½æœ€ä½ç§¯åˆ†ï¼ˆstart of tierï¼‰
                    targetPoints = pointsToStartTier[inputs.targetTier];
                }
            }

            if (startPoints >= targetPoints) {
                showError("ç›®æ ‡æ®µä½å¿…é¡»é«˜äºåˆå§‹æ®µä½ã€‚");
                return;
            }

            // è®¡ç®— pDraw / pWin / pLossï¼ˆä¸æ¡£æ¡ˆå®šä¹‰ä¸€è‡´ï¼‰
            const pDraw = inputs.totalDrawRate / 100;
            const gWR = inputs.gameWinRate / 100;
            const pWin = gWR * (1 - pDraw);
            const pLoss = 1 - pWin - pDraw;
            if (pLoss < 0) {
                showError("è®¡ç®—å‡ºçš„å¤±è´¥ç‡å°äº 0ï¼Œè¯·æ£€æŸ¥èƒœç‡ä¸å¹³å±€ç‡è¾“å…¥ã€‚");
                return;
            }

            // å°†æ€»ä½“èƒœ/è´Ÿåˆ†è§£ä¸ºä¸åŒç»“å±€ï¼ˆç»éªŒæ‹†åˆ†ï¼Œç®€å•è€Œå®ç”¨ï¼‰
            // è¿™äº›æ¯”ç‡å¯ä»¥æ ¹æ®éœ€è¦å†ä½œæ›´ç»†è‡´è°ƒæ•´
            if (inputs.faction === "survivor") {
                inputs.pDraw = pDraw;
                inputs.pWin = pWin;
                inputs.pLoss = pLoss;
                inputs.pFourEscape = pWin * 0.5;     // 50% çš„èƒœå±€æ˜¯å››äººé€ƒè„±ï¼ˆç»éªŒï¼‰
                inputs.pThreeEscape = pWin * 0.5;    // 50% ä¸‰äººé€ƒè„±
                inputs.pSingleEscape = pLoss * 0.35; // å¤±è´¥ä¸­ 35% æ˜¯å•äººé€ƒè„±ï¼ˆé€ƒè„±è€…è·å¾—å°‘é‡æ­£åˆ†ï¼‰
                inputs.pAllDead = pLoss * 0.65;      // å…¶ä½™ä¸ºå…¨ç­
            } else {
                inputs.pDraw = pDraw;
                inputs.pWin = pWin;
                inputs.pLoss = pLoss;
                inputs.pNoEscape = pWin * 0.6;       // 60% èƒœåˆ©ä¸ºæ— äººé€ƒè„±
                inputs.pOneEscape = pWin * 0.4;      // 40% èƒœåˆ©ä¸ºä¸€äººé€ƒè„±
                inputs.pLeaveOne = pLoss * 0.5;      // å¤±è´¥ä¸€åŠç•™ä¸€äººã€ä¸€åŠå…¨è·‘
                inputs.pAllEscape = pLoss * 0.5;
            }

            // ä¸»å¾ªç¯ï¼šæŒ‰æ®µä½åŒºé—´â€œè·³æ­¥â€ä»¥åŠ é€Ÿè®¡ç®—ï¼ˆè€Œéä¸€å±€ä¸€å±€ iterï¼‰
            let totalMatches = 0;
            let currentPoints = startPoints;
            const MAX_MATCHES = 200000;
            let lastAvg = null;

            while (currentPoints < targetPoints) {
                if (totalMatches > MAX_MATCHES) {
                    showError("è®¡ç®—é‡è¿‡å¤§ (>200k åœº)ï¼Œè¯·æ£€æŸ¥è¾“å…¥æ˜¯å¦åˆç†æˆ–è°ƒé«˜èƒœç‡/å‡å°‘ç›®æ ‡ã€‚");
                    return;
                }
                // å½“å‰æ®µä½
                const currentRank = getRankFromPoints(currentPoints);

                // è®¡ç®—è¯¥æ®µä½ä¸‹çš„å¹³å‡æ¯å±€å¾—åˆ†ï¼ˆæœŸæœ›ï¼‰
                const breakdown = calculateExpectedBreakdownPerMatch(inputs, currentRank);
                const avgPointsPerMatch = breakdown.avg;

                // è‹¥äº”é˜¶åŠä»¥ä¸Šä¸” avgPointsPerMatch <= 0ï¼Œåˆ™æ— æ³•ä¸Šåˆ†ï¼ˆæˆ–éœ€è¦éå¸¸å¤šåœºï¼‰
                if (avgPointsPerMatch <= 0 && currentRank.tier >= 5) {
                    showError("åœ¨å½“å‰è¾“å…¥å‚æ•°ä¸‹ï¼Œäº”é˜¶åŠä»¥ä¸Šæ®µä½çš„å¹³å‡æ¯å±€å¾—åˆ† â‰¤ 0ï¼Œæ— æ³•ä¸Šåˆ†ã€‚è¯·æé«˜èƒœç‡æˆ–è°ƒæ•´å‚æ•°ã€‚");
                    return;
                }

                // è®¡ç®—åˆ°ä¸‹ä¸€æ®µä½æˆ–åˆ°ç›®æ ‡æ‰€éœ€ç§¯åˆ†
                const nextTierStart = pointsToStartTier[currentRank.tier + 1] !== undefined ? pointsToStartTier[currentRank.tier + 1] : Infinity;
                // æˆ‘ä»¬æƒ³è¦åˆ°è¾¾çš„â€œé˜¶æ®µæ€§ç›®æ ‡â€æ˜¯ï¼šè‹¥ç›®æ ‡Points åœ¨å½“å‰æ®µä½å†…ï¼Œåˆ™ç”¨ targetPointsï¼›å¦åˆ™ç”¨ nextTierStart
                const phaseTarget = Math.min(targetPoints, nextTierStart - 0.000001); // slight	margin
                const pointsNeeded = Math.max(0, phaseTarget - currentPoints);

                // è‹¥ avgPointsPerMatch éå¸¸æ¥è¿‘ 0ï¼Œé¿å…é™¤é›¶
                if (avgPointsPerMatch <= 0.00001) {
                    // é€€å›åˆ°æ¯å±€è¿­ä»£ï¼ˆä¿å®ˆå¤„ç†ï¼‰
                    totalMatches += 1;
                    currentPoints += 0.00001; // tiny progress to avoid infinite loop
                    continue;
                }

                // æ‰¹é‡è·³æ­¥ï¼šè®¡ç®—éœ€è¦å¤šå°‘å±€å¯ä»¥è¾¾åˆ° phaseTarget
                let neededMatches = Math.ceil(pointsNeeded / avgPointsPerMatch);
                if (neededMatches <= 0) neededMatches = 1;

                // é˜²æ­¢ä¸€æ¬¡è·³æ­¥å¤ªå¤§ä½¿ç§¯åˆ†çªç„¶è·¨è¶Šå¤šä¸ªæ®µä½ï¼ˆæˆ‘ä»¬å…è®¸ï¼Œä½†ä»ä¿æŒ capï¼‰
                // æ·»åŠ ä¸€ä¸ªå®‰å…¨ä¸Šé™ï¼šä¸€æ¬¡æœ€å¤šè·³ 5000 åœº
                if (neededMatches > 5000) neededMatches = 5000;

                // æ›´æ–°
                totalMatches += neededMatches;
                currentPoints += neededMatches * avgPointsPerMatch;

                // å¦‚æœä¸Šæ¬¡ avg å’Œæœ¬æ¬¡ avg å·®åˆ«å·¨å¤§ï¼Œåˆ™æ”¾æ…¢æ­¥ä¼ï¼ˆé¿å…è¯¯å·®ç´¯ç§¯ï¼‰
                if (lastAvg !== null && Math.abs(lastAvg - avgPointsPerMatch) / Math.max(1, lastAvg) > 0.6) {
                    // å‡å°‘æ­¥é•¿ï¼Œæ”¹ä¸º 1/10
                    const smallStep = Math.max(1, Math.floor(neededMatches / 10));
                    totalMatches -= (neededMatches - smallStep);
                    currentPoints -= (neededMatches - smallStep) * avgPointsPerMatch;
                }
                lastAvg = avgPointsPerMatch;
            }

            // è®¡ç®—æ—¶é—´
            const totalTimePerMatch = inputs.queueTime + inputs.matchTime; // minutes
            const totalHours = totalMatches * totalTimePerMatch / 60;
            const totalDays = totalHours / inputs.playHours;

            // æœ€ç»ˆçš„æœŸæœ›å‡€æ”¶ç›Š = æœ€è¿‘ä¸€æ¬¡æ®µä½çš„ avgï¼ˆå±•ç¤ºç”¨ï¼‰
            const finalRank = getRankFromPoints(currentPoints);
            const finalBreakdown = calculateExpectedBreakdownPerMatch(inputs, finalRank);
            const netGain = finalBreakdown.avg;

            // è¾“å‡ºç»“æœï¼ˆè¯¦ç»†ï¼‰
            allDOM.resultDiv.innerHTML = `
                <h3 style="margin-top:0;">ğŸ“Š ä¸Šåˆ†è®¡åˆ’ï¼ˆä¼°ç®—ï¼‰</h3>
                <p><strong>èµ·å§‹ç§¯åˆ†ï¼š</strong>${startPoints.toLocaleString()}</p>
                <p><strong>ç›®æ ‡ç§¯åˆ†ï¼š</strong>${Math.round(targetPoints).toLocaleString()}</p>
                <p><strong>é¢„ä¼°æ€»å¯¹å±€æ•°ï¼š</strong> <span style="font-size:1.18em;color:var(--primary-color);">${totalMatches.toLocaleString()}</span> åœº</p>
                <p><strong>â±ï¸ é¢„ä¼°æ€»è€—æ—¶ï¼š</strong> <span style="font-size:1.02em;color:var(--primary-color);">${totalHours.toFixed(1)}</span> å°æ—¶</p>
                <p><strong>ğŸ“… é¢„ä¼°æ‰€éœ€å¤©æ•°ï¼š</strong> <span style="font-size:1.02em;color:var(--primary-color);">${Math.ceil(totalDays)}</span> å¤©ï¼ˆæŒ‰æ¯å¤© ${inputs.playHours} å°æ—¶è®¡ç®—ï¼‰</p>
                <div style="font-size:0.94em;margin-top:12px;padding-top:12px;border-top:1px dashed #ccc;">
                    <strong>å¹³å‡æ¯å±€å¾—åˆ†æ„æˆï¼ˆä¼°ç®—æœŸæœ›ï¼‰:</strong>
                    <div style="margin-top:8px;">åŸºç¡€èƒœè´Ÿï¼ˆå«å¹³å±€ï¼‰: <span style="color:#008f53;">${(finalBreakdown.baseWinsAndDraws).toFixed(2)}</span></div>
                    <div>æ¼”ç»åˆ†æœŸæœ›: <span style="color:#008f53;">+${finalBreakdown.performance.toFixed(2)}</span></div>
                    <div>æ®µä½ä¿æŠ¤æœŸæœ›: <span style="color:#008f53;">+${finalBreakdown.protection.toFixed(2)}</span></div>
                    <div>å…¶å®ƒé¢å¤–ï¼ˆè™½è´¥/æŒ‚æœº/æœ€ä½³æ¼”ç»/å¤šæ’/å¼ºæ•Œç­‰ï¼‰æœŸæœ›ï¼ˆæœªå¼ºåˆ¶ä¸Šé™ï¼‰: <span style="color:#008f53;">+${finalBreakdown.bonus.toFixed(2)}</span></div>
                    <div style="font-weight:bold;margin-top:6px;">é¢„ä¼°å‡€æ”¶ç›Šï¼ˆå·²å¯¹é¢å¤–é¡¹åšåˆç† capï¼‰ï¼š<span style="color:${netGain>0?"#008f53":"#d93025"}">${netGain.toFixed(2)}</span> åˆ†/å±€</div>
                </div>
                <div style="margin-top:10px;font-size:0.9em;color:#555;">
                    <em>è¯´æ˜ï¼š</em> æœ¬å·¥å…·åŸºäºå®˜æ–¹è§„åˆ™ä¸ç»éªŒæ‹†åˆ†åšæœŸæœ›å€¼ä¼°ç®—ï¼Œç»“æœä»ä¸ºç†è®ºå€¼ï¼›æ¼”ç»åˆ†ã€ç‰¹æ®Šæˆå°±ç­‰åœ¨å•å±€æ³¢åŠ¨è¾ƒå¤§ï¼Œå®é™…ç»“æœä¼šæœ‰æ³¢åŠ¨ã€‚                    
                </div>
            `;
            allDOM.resultDiv.style.display = "block";
            window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
        });

        /**********************
         * é‡ç½®ä¸èµ›å­£é‡ç½®æŒ‰é’®
         **********************/
        allDOM.resetFormBtn.addEventListener("click", () => {
            const currentFaction = allDOM.factionSelect.value;
            document.getElementById("calculator-form").reset();
            allDOM.factionSelect.value = currentFaction;
            allDOM.resultDiv.style.display = "none";
            allDOM.errorMessageDiv.style.display = "none";
            // æ¢å¤æ»‘æ¡é»˜è®¤å€¼ï¼ˆè¾ƒä¿å®ˆï¼‰
            const defaults = {diligenceFreq:20, afkFreq:0.5, bestPerfFreq:30, teamEncounterFreq:40, strongEnemyFreq:40};
            for (const k in defaults) {
                const el = document.getElementById(k);
                const valEl = document.getElementById(k + "Value");
                if (el && valEl) {
                    el.value = defaults[k];
                    valEl.textContent = `${defaults[k]}%`;
                }
            }
            updateSubTierSelect(allDOM.startTier, allDOM.startSubTier, 'start');
            updateSubTierSelect(allDOM.targetTier, allDOM.targetSubTier, 'target');
            updateSubTierSelect(allDOM.seasonEndTier, allDOM.seasonEndSubTier, 'seasonEnd');
            updateStartStarsSelect();
            allDOM.factionSelect.dispatchEvent(new Event('change'));
        });

        allDOM.resetBtn.addEventListener("click", () => {
            const tierId = allDOM.seasonEndTier.value, subTierId = allDOM.seasonEndSubTier.value;
            const key = `${tierId}-${subTierId}`;
            // ä½ çš„åŸå§‹é‡ç½®æ˜ å°„ï¼ˆä¸ç”¨æˆ·æœ€åˆä¿æŒä¸€è‡´ï¼‰
            const seasonResetMap = {'1-3':'1-3','1-2':'1-2','1-1':'1-1','2-4':'2-4','2-3':'2-3','2-2':'2-2','2-1':'2-1','3-5':'2-1','3-4':'3-5','3-3':'3-4','3-2':'3-3','3-1':'3-3','4-5':'3-2','4-4':'3-1','4-3':'3-1','4-2':'4-5','4-1':'4-4','5-5':'4-4','5-4':'4-3','5-3':'4-2','5-2':'4-2','5-1':'4-1','6-5':'4-1','6-4':'5-5','6-3':'5-5','6-2':'5-4','6-1':'5-4','7-1':'5-3','8-1':'5-2'};
            const resetKey = seasonResetMap[key];
            if (resetKey) {
                const [newTierId, newSubTierId] = resetKey.split("-");
                const newTier = rankData[parseInt(newTierId)-1];
                const newSubTierName = newTier.id < 7 ? ` ${subTierNames[parseInt(newSubTierId)-1]}` : "";
                allDOM.resetResultDiv.innerHTML = `æ–°èµ›å­£æ®µä½ä¸ºï¼š<span style="color:var(--primary-color);">${newTier.name}${newSubTierName}</span>`;
            } else {
                allDOM.resetResultDiv.textContent = "æœªæ‰¾åˆ°è¯¥æ®µä½çš„é‡ç½®ä¿¡æ¯ã€‚";
            }
        });

        /**********************
         * å…¬å…±ï¼šæ˜¾ç¤ºé”™è¯¯
         **********************/
        function showError(message) {
            allDOM.errorMessageDiv.textContent = message;
            allDOM.errorMessageDiv.style.display = "block";
            allDOM.resultDiv.style.display = "none";
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

    });
    </script>
</body>
</html>
